unit UORM;

interface

uses
  Data.SqlExpr,SysUtils, classes, System.Rtti, System.TypInfo, System.Generics.Collections, Models;

type
TPaginate = class
  public
     Skip : Integer;
     Take : Integer;
     Total: Integer;
     CurrentPage : Integer;

     constructor Create(pSkip,pTake,pTotal,pCurrentPage : integer);
end;

TORM = class
   private
      FQuery : TSQLQuery;
      FPpropInfo : PPropInfo;
      FCtx : TRttiContext;
      FTypeInfo : PTypeInfo;
      FProp: TRttiProperty;
      TypeObject : TRttiType;
      FClassName : String;
      FKey : string;
      FAutoIncremment : boolean;
   public
     procedure  Add(pObject : TObject);
     procedure  Remove(pObject: TObject);
     procedure  Update(pObject : TObject);
     procedure  SaveChange();
     class function CreateInstance<T:class,constructor>: T;
     function PropertyNameFormat(pProp : string):string;
     function GetAll<T:class,constructor>(pPaginate : TPaginate): TObjectList<T>;
     function GetPropertyValue(pProp : string; ArrayFields : TArray<TRttiField>; pObject: TObject) : string;
     constructor Create(PConexao : TSQLConnection);
end;



implementation

{ TORM }

function TORM.GetAll<T>(pPaginate : TPaginate): TObjectList<T>;
var
  modelList : TObjectList<T>;
  model,modelAdd : T;
  ArrayFields : TArray<TRttiField>;
  I : integer;
  vPropriedade: TRttiProperty;
begin
   try
       modelList   := TObjectList<T>.Create();
       model       := CreateInstance<T>;

       TypeObject  := FCtx.GetType(model.ClassType);
       ArrayFields := TypeObject.GetFields;
       FClassName  := Copy(TypeObject.Name,2,length(TypeObject.Name)-1);

       FQuery.SQL.Clear;
       FQuery.SQL.Add('SELECT * FROM '+FClassName+' LIMIT '+pPaginate.Skip.ToString+','+pPaginate.Take.ToString());
       FQuery.Open;

       FQuery.First;
       while not FQuery.Eof do
       begin
           modelAdd     := CreateInstance<T>;
           for I := 0 to length(ArrayFields)-1 do
           begin

              if not((ArrayFields[I].Name = 'key') or (ArrayFields[I].Name = 'AutoIncremment'))then
              begin

                 vPropriedade := TypeObject.GetProperty(Copy(ArrayFields[I].Name,2,ArrayFields[I].Name.Length-1));

                 if (ArrayFields[I].FieldType.ToString = 'Currency') or (ArrayFields[I].FieldType.ToString = 'Float') then
                    vPropriedade.SetValue(Pointer(modelAdd), FQuery.FindField(Copy(ArrayFields[I].Name,2,ArrayFields[I].Name.Length-1)).AsCurrency)

                 else if ArrayFields[I].FieldType.ToString = 'string' then
                   vPropriedade.SetValue(Pointer(modelAdd), FQuery.FindField(Copy(ArrayFields[I].Name,2,ArrayFields[I].Name.Length-1)).AsString)

                 else if ArrayFields[I].FieldType.ToString = 'Boolean' then
                 begin
                     if FQuery.FindField(Copy(ArrayFields[I].Name,2,ArrayFields[I].Name.Length-1)).AsInteger = 0 then
                         vPropriedade.SetValue(Pointer(modelAdd), False )
                     else
                         vPropriedade.SetValue(Pointer(modelAdd), True )
                 end
                 else if (ArrayFields[I].FieldType.ToString = 'TDate') or (ArrayFields[I].FieldType.ToString = 'TDateTime') then
                    vPropriedade.SetValue(Pointer(modelAdd), FQuery.FindField(Copy(ArrayFields[I].Name,2,ArrayFields[I].Name.Length-1)).AsDateTime)

                 else if ArrayFields[I].FieldType.ToString = 'Integer' then
                    vPropriedade.SetValue(Pointer(modelAdd), FQuery.FindField(Copy(ArrayFields[I].Name,2,ArrayFields[I].Name.Length-1)).AsInteger);
              end;

           end;

          modelList.Add(modelAdd);
          FQuery.Next;
       end;
   finally
       model.free;
   end;

   Result :=  modelList;
end;

function TORM.GetPropertyValue(pProp : string; ArrayFields : TArray<TRttiField>; pObject: TObject) : string;
var
    I: Integer;
    propResult : string;
begin
   propResult := string.empty;
   for I := 0 to length(ArrayFields)-1 do
      if ArrayFields[I].Name = pProp then
      begin
         propResult := ArrayFields[I].GetValue(pObject).ToString;
         Break;
      end;

   Result := propResult;
end;

function TORM.PropertyNameFormat(pProp: string): string;
begin
    Result := Copy(pProp,2,pProp.Length-1);
end;

constructor TORM.Create(PConexao: TSQLConnection);
begin
   FQuery := TSQLQuery.Create(nil);
   FQuery.SQLConnection := PConexao;
   FQuery.SQL.Clear;
   FCtx   := TRttiContext.Create;
end;

class function TORM.CreateInstance<T>: T;
begin
   Result := T.Create();
end;

procedure TORM.Remove(pObject: TObject);
var
  ArrayFields : TArray<TRttiField>;
  I: Integer;
begin
   TypeObject  := FCtx.GetType(pObject.ClassType);
   FTypeInfo   := TypeObject.Handle;
   ArrayFields := TypeObject.GetFields;
   FClassName  := Copy(TypeObject.Name,2,length(TypeObject.Name)-1);
   FPpropInfo  := GetPropInfo(pObject.ClassType,ArrayFields[0].Name);

   FQuery.SQL.Add('DELETE FROM '+FClassName);

   for I := 0 to length(ArrayFields)-1 do
   begin
      if ArrayFields[I].Name = 'key' then
      FQuery.SQL.Add(' WHERE '+ArrayFields[I].GetValue(pObject).ToString+
      ' = "'+GetPropertyValue(ArrayFields[I].GetValue(pObject).ToString,ArrayFields,pObject)+'";');
   end;
end;

procedure TORM.SaveChange;
begin
    FQuery.ExecSQL();
    FQuery.SQL.Clear;
end;

procedure TORM.Update(pObject: TObject);
var
  ArrayFields : TArray<TRttiField>;
  I : Integer;
  SqlFields, SqlValues : string;
begin
    TypeObject  := FCtx.GetType(pObject.ClassType);
    FTypeInfo   := TypeObject.Handle;
    ArrayFields := TypeObject.GetFields;
    FClassName  := Copy(TypeObject.Name,2,length(TypeObject.Name)-1);
    SqlValues   := string.empty;
    SqlFields   := string.empty;

    FQuery.SQL.Add(' UPDATE '+FClassName+' SET ');
    for I := 0 to length(ArrayFields)-1 do
    begin
       if(ArrayFields[I].Name = 'AutoIncremment')then
       begin
         FAutoIncremment := strToBool(ArrayFields[I].GetValue(pObject).ToString);
         continue;
       end;

       if(ArrayFields[I].Name = 'key')then
       begin
         FKey := ArrayFields[I].GetValue(pObject).ToString;
         continue;
       end;
       if(ArrayFields[I].FieldType.ToString = 'string') then
          SqlValues := SqlValues+ArrayFields[I].Name+'='+QuotedStr(ArrayFields[I].GetValue(pObject).ToString)+','
       else if((ArrayFields[I].FieldType.ToString = 'Boolean'))then
       begin
           if(ArrayFields[I].GetValue(pObject).ToString = 'True')then
             SqlValues := SqlValues+ArrayFields[I].Name+'='+'1,'
           else
           SqlValues := SqlValues+ArrayFields[I].Name+'='+'0,'
       end
       else if(ArrayFields[I].FieldType.ToString = 'Currency')
       or(ArrayFields[I].FieldType.ToString = 'Float')
       or(ArrayFields[I].FieldType.ToString = 'Decimal')
       or(ArrayFields[I].FieldType.ToString = 'Real')
       then
       begin
           SqlValues := SqlValues+ArrayFields[I].Name+'='+ArrayFields[I].GetValue(pObject).ToString.Replace(',','.')+','
       end
       else if(ArrayFields[I].FieldType.ToString = 'TDateTime')or(ArrayFields[I].FieldType.ToString = 'TDate')then
       begin
          SqlValues := SqlValues+ArrayFields[I].Name+
          '='+QuotedStr(formatDateTime('yyyy-mm-dd',StrToDate(ArrayFields[I].GetValue(pObject).ToString)))+','
       end
       else
           SqlValues := SqlValues+ArrayFields[I].Name+'='+ArrayFields[I].GetValue(pObject).ToString+','

    end;
    FQuery.SQL.Add(copy(SqlValues,1,SqlValues.Length-1));
    for I := 0 to length(ArrayFields)-1 do
    begin
      if ArrayFields[I].Name = 'key' then
      FQuery.SQL.Add(' WHERE '+ArrayFields[I].GetValue(pObject).ToString+' = "'+GetPropertyValue(ArrayFields[I].GetValue(pObject).ToString,ArrayFields,pObject)+'";');
   end;

end;

procedure TORM.Add(pObject: TObject);
var
  ArrayFields : TArray<TRttiField>;
  I: Integer;
  SqlFields,SqlValues : string;
begin
   TypeObject := FCtx.GetType(pObject.ClassType);
   FTypeInfo  := TypeObject.Handle;
   ArrayFields:= TypeObject.GetFields;
   FClassName := Copy(TypeObject.Name,2,length(TypeObject.Name)-1);
   SqlValues  := string.empty;
   SqlFields  := string.empty;

   FQuery.SQL.Clear();
   FQuery.SQL.Add('INSERT INTO '+FClassName+'(');

   for I := 0 to length(ArrayFields)-1 do
   begin
      if(PropertyNameFormat(ArrayFields[I].Name) = 'AutoIncremment')then
      begin
         FAutoIncremment := strToBool(ArrayFields[I].GetValue(pObject).ToString);
         continue;
      end;

      if(PropertyNameFormat(ArrayFields[I].Name) = 'key')then
      begin
         FKey := ArrayFields[I].GetValue(pObject).ToString;
         continue;
      end;
      SqlFields := SqlFields + PropertyNameFormat(ArrayFields[I].Name)+',';
   end;

   FQuery.SQL.Add(copy(SqlFields,1,SqlFields.Length -1)+')');
   FQuery.SQL.Add(' VALUES (');

   for I := 0 to length(ArrayFields)-1 do
   begin
       if(PropertyNameFormat(ArrayFields[I].Name) = 'key') or (PropertyNameFormat(ArrayFields[I].Name) = 'AutoIncremment')then
          continue;

       if(ArrayFields[I].FieldType.ToString = 'string') then
           SqlValues := SqlValues + QuotedStr(ArrayFields[I].GetValue(pObject).ToString)+','

       else if((ArrayFields[I].FieldType.ToString = 'Boolean'))then
       begin
           if(ArrayFields[I].GetValue(pObject).ToString = 'True')then
             SqlValues := SqlValues +'1,'
           else
              SqlValues := SqlValues +'0,'
       end
       else if(ArrayFields[I].FieldType.ToString = 'Currency')
       or(ArrayFields[I].FieldType.ToString = 'Float')
       or(ArrayFields[I].FieldType.ToString = 'Decimal')
       or(ArrayFields[I].FieldType.ToString = 'Real')
       then
       begin
           SqlValues := SqlValues + (ArrayFields[I].GetValue(pObject).ToString).Replace(',','.')+','
       end
       else if(ArrayFields[I].FieldType.ToString = 'TDateTime')or(ArrayFields[I].FieldType.ToString = 'TDate')then
       begin
           SqlValues := SqlValues + QuotedStr(formatDateTime('yyyy-mm-dd',strTodate(ArrayFields[I].GetValue(pObject).ToString)))+','
       end
       else
           SqlValues := SqlValues + ArrayFields[I].GetValue(pObject).ToString+','
   end;
   FQuery.SQL.Add(copy(SqlValues,1,SqlValues.Length -1)+');');
   //comentário para commit

end;


{ TPaginate }

constructor TPaginate.Create(pSkip, pTake, pTotal, pCurrentPage: integer);
begin
   Skip := pSkip;
   Take := pTake;
   Total := pTotal;
   CurrentPage :=  pCurrentPage;
end;

end.
